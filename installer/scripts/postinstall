#!/bin/bash

# Remove quarantine attribute (downloaded from internet)
xattr -dr com.apple.quarantine /usr/local/bin/apple-notes-bridge 2>/dev/null
xattr -dr com.apple.quarantine "/Applications/Notes Bridge.app" 2>/dev/null

# --- MCP Auto-Configuration ---
# postinstall runs as root, so we need to find the actual console user

CONSOLE_USER=$(stat -f '%Su' /dev/console 2>/dev/null)
if [ -z "$CONSOLE_USER" ] || [ "$CONSOLE_USER" = "root" ]; then
    CONSOLE_USER=$(scutil <<< "show State:/Users/ConsoleUser" | awk '/Name :/ { print $3 }')
fi

if [ -z "$CONSOLE_USER" ] || [ "$CONSOLE_USER" = "root" ] || [ "$CONSOLE_USER" = "loginwindow" ]; then
    echo "Note: Could not detect console user. Run 'apple-notes-bridge setup' to configure Claude Code."
    exit 0
fi

CONSOLE_HOME=$(eval echo "~$CONSOLE_USER")

# Find claude CLI in common locations
CLAUDE_BIN=""
for candidate in \
    "/usr/local/bin/claude" \
    "$CONSOLE_HOME/.local/bin/claude" \
    "$CONSOLE_HOME/.claude/bin/claude" \
    "/opt/homebrew/bin/claude" \
    "/usr/bin/claude"; do
    if [ -x "$candidate" ]; then
        CLAUDE_BIN="$candidate"
        break
    fi
done

if [ -n "$CLAUDE_BIN" ]; then
    # Run MCP config as the console user (not root)
    if sudo -u "$CONSOLE_USER" "$CLAUDE_BIN" mcp add apple-notes-bridge --scope user -- /usr/local/bin/apple-notes-bridge serve 2>&1; then
        echo "MCP server 'apple-notes-bridge' registered with Claude Code."
    else
        echo "Note: Auto-configuration failed. Run 'apple-notes-bridge setup' to configure manually."
    fi
else
    echo "Note: Claude Code CLI not found. Run 'apple-notes-bridge setup' after installing Claude Code."
fi

exit 0
